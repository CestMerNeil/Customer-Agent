name: Test Build (Development)

on:
  push:
    branches: [ develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  APP_NAME: "æ‹¼å¤šå¤šæ™ºèƒ½å®¢æœç³»ç»Ÿ"
  PYTHON_VERSION: "3.11"

jobs:
  test-windows:
    name: Test Windows Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Test Import
      run: |
        python -c "
        try:
            from PyQt6.QtWidgets import QApplication
            from qfluentwidgets import FluentWindow
            import playwright
            print('âœ… æ‰€æœ‰å…³é”®ä¾èµ–å¯¼å…¥æˆåŠŸ')
        except ImportError as e:
            print(f'âŒ ä¾èµ–å¯¼å…¥å¤±è´¥: {e}')
            exit(1)
        "
    
    - name: Quick Build Test
      run: |
        # åˆ›å»ºæœ€å°åŒ–çš„æµ‹è¯•æ„å»º
        pyinstaller --onefile --console --name="test-build" app.py
        if (Test-Path "dist/test-build.exe") {
          Write-Host "âœ… Windows æµ‹è¯•æ„å»ºæˆåŠŸ"
        } else {
          Write-Host "âŒ Windows æµ‹è¯•æ„å»ºå¤±è´¥"
          exit 1
        }
      shell: powershell

  test-macos:
    name: Test macOS Build
    runs-on: macos-14  # Apple Silicon
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Test Import
      run: |
        python -c "
        try:
            from PyQt6.QtWidgets import QApplication
            from qfluentwidgets import FluentWindow
            import playwright
            print('âœ… æ‰€æœ‰å…³é”®ä¾èµ–å¯¼å…¥æˆåŠŸ')
        except ImportError as e:
            print(f'âŒ ä¾èµ–å¯¼å…¥å¤±è´¥: {e}')
            exit(1)
        "
    
    - name: Quick Build Test
      run: |
        # åˆ›å»ºæœ€å°åŒ–çš„æµ‹è¯•æ„å»º
        pyinstaller --onefile --console --name="test-build" --target-arch="arm64" app.py
        if [ -f "dist/test-build" ]; then
          echo "âœ… macOS æµ‹è¯•æ„å»ºæˆåŠŸ"
        else
          echo "âŒ macOS æµ‹è¯•æ„å»ºå¤±è´¥"
          exit 1
        fi

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install Quality Tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort
    
    - name: Check Code Style
      run: |
        echo "ğŸ” æ£€æŸ¥ä»£ç é£æ ¼..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Check Import Order
      run: |
        echo "ğŸ“¦ æ£€æŸ¥å¯¼å…¥é¡ºåº..."
        isort . --check-only --diff
      continue-on-error: true
    
    - name: Check Code Formatting
      run: |
        echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
        black . --check --diff
      continue-on-error: true