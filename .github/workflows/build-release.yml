name: Build Multi-Platform Release

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      create_release:
        description: 'åˆ›å»º GitHub Release'
        required: false
        default: false
        type: boolean

env:
  APP_NAME: "æ‹¼å¤šå¤šæ™ºèƒ½å®¢æœç³»ç»Ÿ"
  PYTHON_VERSION: "3.11"

jobs:
  build-windows:
    name: Build Windows Application
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install System Dependencies
      run: |
        # å®‰è£… Visual C++ æž„å»ºå·¥å…·ï¼ˆæŸäº›åŒ…å¯èƒ½éœ€è¦ï¼‰
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools"
      shell: powershell
      continue-on-error: true
    
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pyinstaller>=6.0.0
    
    - name: Install Playwright Browsers
      run: |
        playwright install chrome --with-deps
    
    - name: Prepare Build Environment
      run: |
        # åˆ›å»ºå›¾æ ‡ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        if (!(Test-Path "icon")) {
          New-Item -ItemType Directory -Force -Path "icon"
        }
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if (!(Test-Path "config.json")) {
          echo '{"coze_api_base": "https://api.coze.cn", "coze_token": "", "coze_bot_id": "", "bot_type": "coze"}' | Out-File -FilePath "config.json" -Encoding UTF8
        }
      shell: powershell
    
    - name: Build Windows Executable
      run: |
        pyinstaller --clean --noconfirm `
          --onefile `
          --windowed `
          --name="${{ env.APP_NAME }}" `
          --add-data="icon;icon" `
          --add-data="config.json;." `
          --add-data="database;database" `
          --hidden-import="PyQt6.QtCore" `
          --hidden-import="PyQt6.QtWidgets" `
          --hidden-import="PyQt6.QtGui" `
          --hidden-import="qfluentwidgets" `
          --hidden-import="playwright" `
          --hidden-import="Agent.CozeAgent.bot" `
          --hidden-import="Agent.DifyAgent.bot" `
          --hidden-import="Channel.pinduoduo.pdd_channel" `
          --collect-all="qfluentwidgets" `
          --collect-all="playwright" `
          app.py
      shell: powershell
    
    - name: Test Windows Executable
      run: |
        if (Test-Path "dist/${{ env.APP_NAME }}.exe") {
          Write-Host "âœ… Windows å¯æ‰§è¡Œæ–‡ä»¶æž„å»ºæˆåŠŸ"
          $fileSize = (Get-Item "dist/${{ env.APP_NAME }}.exe").Length / 1MB
          Write-Host "ðŸ“¦ æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
        } else {
          Write-Host "âŒ Windows å¯æ‰§è¡Œæ–‡ä»¶æž„å»ºå¤±è´¥"
          exit 1
        }
      shell: powershell
    
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-x64-executable
        path: dist/${{ env.APP_NAME }}.exe
        retention-days: 30

  build-macos:
    name: Build macOS Application (Apple Silicon)
    runs-on: macos-14  # Apple Silicon runner
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install System Dependencies
      run: |
        # å®‰è£… Homebrew ä¾èµ–ï¼ˆå¦‚æžœéœ€è¦ï¼‰
        brew update
        brew install --cask google-chrome  # Playwright éœ€è¦
    
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pyinstaller>=6.0.0
    
    - name: Install Playwright Browsers
      run: |
        playwright install chrome --with-deps
    
    - name: Prepare Build Environment
      run: |
        # åˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶
        mkdir -p icon database
        
        # åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        if [ ! -f "config.json" ]; then
          echo '{"coze_api_base": "https://api.coze.cn", "coze_token": "", "coze_bot_id": "", "bot_type": "coze"}' > config.json
        fi
    
    - name: Build macOS Application
      run: |
        pyinstaller --clean --noconfirm \
          --onefile \
          --windowed \
          --name="${{ env.APP_NAME }}" \
          --add-data="icon:icon" \
          --add-data="config.json:." \
          --add-data="database:database" \
          --hidden-import="PyQt6.QtCore" \
          --hidden-import="PyQt6.QtWidgets" \
          --hidden-import="PyQt6.QtGui" \
          --hidden-import="qfluentwidgets" \
          --hidden-import="playwright" \
          --hidden-import="Agent.CozeAgent.bot" \
          --hidden-import="Agent.DifyAgent.bot" \
          --hidden-import="Channel.pinduoduo.pdd_channel" \
          --collect-all="qfluentwidgets" \
          --collect-all="playwright" \
          --target-arch="arm64" \
          app.py
    
    - name: Create macOS App Bundle
      run: |
        # åˆ›å»º .app åŒ…ç»“æž„
        APP_DIR="dist/${{ env.APP_NAME }}.app"
        mkdir -p "$APP_DIR/Contents/MacOS"
        mkdir -p "$APP_DIR/Contents/Resources"
        
        # ç§»åŠ¨å¯æ‰§è¡Œæ–‡ä»¶
        mv "dist/${{ env.APP_NAME }}" "$APP_DIR/Contents/MacOS/"
        
        # åˆ›å»º Info.plist
        cat > "$APP_DIR/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>${{ env.APP_NAME }}</string>
            <key>CFBundleIdentifier</key>
            <string>com.jc0v0.pdd-customer-agent</string>
            <key>CFBundleName</key>
            <string>${{ env.APP_NAME }}</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
            <key>LSRequiresNativeExecution</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # åˆ›å»º DMG æ–‡ä»¶
        hdiutil create -volname "${{ env.APP_NAME }}" -srcfolder "$APP_DIR" -ov -format UDZO "dist/${{ env.APP_NAME }}-macOS-arm64.dmg"
    
    - name: Test macOS Application
      run: |
        if [ -f "dist/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}" ]; then
          echo "âœ… macOS åº”ç”¨æž„å»ºæˆåŠŸ"
          file_size=$(du -m "dist/${{ env.APP_NAME }}-macOS-arm64.dmg" | cut -f1)
          echo "ðŸ“¦ DMG æ–‡ä»¶å¤§å°: ${file_size} MB"
        else
          echo "âŒ macOS åº”ç”¨æž„å»ºå¤±è´¥"
          exit 1
        fi
    
    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm64-dmg
        path: dist/${{ env.APP_NAME }}-macOS-arm64.dmg
        retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-x64-executable
        path: ./artifacts/windows/
    
    - name: Download macOS Artifact
      uses: actions/download-artifact@v4
      with:
        name: macos-arm64-dmg
        path: ./artifacts/macos/
    
    - name: Prepare Release Assets
      run: |
        mkdir -p release-assets
        
        # é‡å‘½åæ–‡ä»¶ä»¥åŒ…å«å¹³å°ä¿¡æ¯
        cp "./artifacts/windows/${{ env.APP_NAME }}.exe" "./release-assets/${{ env.APP_NAME }}-Windows-x64.exe"
        cp "./artifacts/macos/${{ env.APP_NAME }}-macOS-arm64.dmg" "./release-assets/"
        
        # åˆ›å»ºæ ¡éªŒå’Œæ–‡ä»¶
        cd release-assets
        sha256sum * > SHA256SUMS.txt
        cd ..
    
    - name: Generate Release Notes
      run: |
        cat > release-notes.md << EOF
        # ${{ env.APP_NAME }} Release
        
        ## ðŸ“¦ ä¸‹è½½
        
        ### Windows (x64)
        - **${{ env.APP_NAME }}-Windows-x64.exe** - Windows 10/11 å¯æ‰§è¡Œæ–‡ä»¶
        
        ### macOS (Apple Silicon)
        - **${{ env.APP_NAME }}-macOS-arm64.dmg** - macOS 11+ (M1/M2/M3 èŠ¯ç‰‡)
        
        ## ðŸš€ å®‰è£…è¯´æ˜Ž
        
        ### Windows
        1. ä¸‹è½½ \`${{ env.APP_NAME }}-Windows-x64.exe\`
        2. åŒå‡»è¿è¡Œå³å¯
        3. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨å®‰è£…æµè§ˆå™¨é©±åŠ¨
        
        ### macOS
        1. ä¸‹è½½ \`${{ env.APP_NAME }}-macOS-arm64.dmg\`
        2. åŒå‡»æŒ‚è½½ DMG æ–‡ä»¶
        3. å°†åº”ç”¨æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
        4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        
        - é¦–æ¬¡è¿è¡Œéœ€è¦ç½‘ç»œè¿žæŽ¥ä»¥ä¸‹è½½æµè§ˆå™¨é©±åŠ¨
        - è¯·ç¡®ä¿ç³»ç»Ÿæ»¡è¶³æœ€ä½Žè¦æ±‚ï¼š
          - Windows: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - macOS: macOS 11 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆApple Siliconï¼‰
        
        ## ðŸ”’ æ–‡ä»¶æ ¡éªŒ
        
        è¯·ä½¿ç”¨ SHA256SUMS.txt éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚
        EOF
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name || format('v{0}', github.run_number) }}
        name: ${{ env.APP_NAME }} ${{ github.ref_name || format('v{0}', github.run_number) }}
        body_path: release-notes.md
        files: |
          release-assets/*
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-completion:
    name: Notify Build Completion
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build Status Summary
      run: |
        echo "## ðŸ—ï¸ æž„å»ºçŠ¶æ€æ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows x64 | ${{ needs.build-windows.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS ARM64 | ${{ needs.build-macos.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.build-windows.result }}" == "success" && "${{ needs.build-macos.result }}" == "success" ]]; then
          echo "ðŸŽ‰ æ‰€æœ‰å¹³å°æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ éƒ¨åˆ†å¹³å°æž„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
        fi