name: Build Multi-Platform Release (Fixed)

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      create_release:
        description: 'åˆ›å»º GitHub Release'
        required: false
        default: false
        type: boolean

env:
  APP_NAME: "æ‹¼å¤šå¤šæ™ºèƒ½å®¢æœç³»ç»Ÿ"
  PYTHON_VERSION: "3.11"

jobs:
  build-windows:
    name: Build Windows Application
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install System Dependencies
      run: |
        # å®‰è£… Visual C++ æ„å»ºå·¥å…·ï¼ˆæŸäº›åŒ…å¯èƒ½éœ€è¦ï¼‰
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools" --no-progress
      shell: powershell
      continue-on-error: true
    
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pyinstaller>=6.0.0
    
    - name: Install Playwright Browsers
      run: |
        python -m playwright install chrome --with-deps
      continue-on-error: true  # å¦‚æœå®‰è£…å¤±è´¥ï¼Œç»§ç»­æ„å»ºï¼Œè¿è¡Œæ—¶å†å®‰è£…
    
    - name: Prepare Build Environment
      run: |
        # åˆ›å»ºå›¾æ ‡ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if (!(Test-Path "icon")) {
          New-Item -ItemType Directory -Force -Path "icon"
        }
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if (!(Test-Path "config.json")) {
          $config = @{
            coze_api_base = "https://api.coze.cn"
            coze_token = ""
            coze_bot_id = ""
            bot_type = "coze"
            businessHours = @{
              start = "08:00"
              end = "23:00"
            }
          }
          $config | ConvertTo-Json -Depth 3 | Out-File -FilePath "config.json" -Encoding UTF8
        }
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼Œå¤„ç† Playwright é¦–æ¬¡è¿è¡Œ
        $startupScript = @"
import sys
import os
import subprocess
from pathlib import Path

def ensure_playwright_browsers():
    try:
        # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…æµè§ˆå™¨
        import playwright
        from playwright.sync_api import sync_playwright
        
        with sync_playwright() as p:
            try:
                browser = p.chromium.launch(headless=True)
                browser.close()
                return True
            except Exception:
                print("æ­£åœ¨å®‰è£…æµè§ˆå™¨é©±åŠ¨...")
                subprocess.run([sys.executable, "-m", "playwright", "install", "chrome"], check=True)
                return True
    except Exception as e:
        print(f"æµè§ˆå™¨é©±åŠ¨å®‰è£…å¤±è´¥: {e}")
        return False

if __name__ == "__main__":
    # ç¡®ä¿æµè§ˆå™¨é©±åŠ¨å·²å®‰è£…
    ensure_playwright_browsers()
    
    # å¯åŠ¨ä¸»åº”ç”¨
    from app import main
    main()
"@
        $startupScript | Out-File -FilePath "startup.py" -Encoding UTF8
      shell: powershell
    
    - name: Build Windows Executable
      run: |
        pyinstaller --clean --noconfirm `
          --onefile `
          --windowed `
          --name="${{ env.APP_NAME }}" `
          --add-data="icon;icon" `
          --add-data="config.json;." `
          --add-data="database;database" `
          --hidden-import="PyQt6.QtCore" `
          --hidden-import="PyQt6.QtWidgets" `
          --hidden-import="PyQt6.QtGui" `
          --hidden-import="qfluentwidgets" `
          --hidden-import="playwright" `
          --hidden-import="playwright.sync_api" `
          --hidden-import="Agent.CozeAgent.bot" `
          --hidden-import="Agent.DifyAgent.bot" `
          --hidden-import="Channel.pinduoduo.pdd_channel" `
          --collect-all="qfluentwidgets" `
          --collect-submodules="playwright" `
          startup.py
      shell: powershell
    
    - name: Test Windows Executable
      run: |
        if (Test-Path "dist/${{ env.APP_NAME }}.exe") {
          Write-Host "âœ… Windows å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ"
          $fileSize = (Get-Item "dist/${{ env.APP_NAME }}.exe").Length / 1MB
          Write-Host "ğŸ“¦ æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
        } else {
          Write-Host "âŒ Windows å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå¤±è´¥"
          Get-ChildItem "dist" -Recurse
          exit 1
        }
      shell: powershell
    
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-x64-executable
        path: dist/${{ env.APP_NAME }}.exe
        retention-days: 30

  build-macos:
    name: Build macOS Application (Apple Silicon)
    runs-on: macos-14  # Apple Silicon runner
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install System Dependencies
      run: |
        # æ›´æ–° Homebrew
        brew update
        # å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
        brew install --cask google-chrome || true
    
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pyinstaller>=6.0.0
    
    - name: Install Playwright Browsers
      run: |
        python -m playwright install chrome --with-deps
      continue-on-error: true  # å¦‚æœå®‰è£…å¤±è´¥ï¼Œç»§ç»­æ„å»º
    
    - name: Prepare Build Environment
      run: |
        # åˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶
        mkdir -p icon database
        
        # åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "config.json" ]; then
          cat > config.json << EOF
        {
          "coze_api_base": "https://api.coze.cn",
          "coze_token": "",
          "coze_bot_id": "",
          "bot_type": "coze",
          "businessHours": {
            "start": "08:00",
            "end": "23:00"
          }
        }
        EOF
        fi
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > startup.py << 'EOF'
        import sys
        import os
        import subprocess
        from pathlib import Path
        
        def ensure_playwright_browsers():
            try:
                # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…æµè§ˆå™¨
                import playwright
                from playwright.sync_api import sync_playwright
                
                with sync_playwright() as p:
                    try:
                        browser = p.chromium.launch(headless=True)
                        browser.close()
                        return True
                    except Exception:
                        print("æ­£åœ¨å®‰è£…æµè§ˆå™¨é©±åŠ¨...")
                        subprocess.run([sys.executable, "-m", "playwright", "install", "chrome"], check=True)
                        return True
            except Exception as e:
                print(f"æµè§ˆå™¨é©±åŠ¨å®‰è£…å¤±è´¥: {e}")
                return False
        
        if __name__ == "__main__":
            # ç¡®ä¿æµè§ˆå™¨é©±åŠ¨å·²å®‰è£…
            ensure_playwright_browsers()
            
            # å¯åŠ¨ä¸»åº”ç”¨
            from app import main
            main()
        EOF
    
    - name: Build macOS Application
      run: |
        pyinstaller --clean --noconfirm \
          --onefile \
          --windowed \
          --name="${{ env.APP_NAME }}" \
          --add-data="icon:icon" \
          --add-data="config.json:." \
          --add-data="database:database" \
          --hidden-import="PyQt6.QtCore" \
          --hidden-import="PyQt6.QtWidgets" \
          --hidden-import="PyQt6.QtGui" \
          --hidden-import="qfluentwidgets" \
          --hidden-import="playwright" \
          --hidden-import="playwright.sync_api" \
          --hidden-import="Agent.CozeAgent.bot" \
          --hidden-import="Agent.DifyAgent.bot" \
          --hidden-import="Channel.pinduoduo.pdd_channel" \
          --collect-all="qfluentwidgets" \
          --collect-submodules="playwright" \
          --target-arch="arm64" \
          startup.py
    
    - name: Create macOS App Bundle and DMG
      run: |
        # åˆ›å»º .app åŒ…ç»“æ„
        APP_DIR="dist/${{ env.APP_NAME }}.app"
        mkdir -p "$APP_DIR/Contents/MacOS"
        mkdir -p "$APP_DIR/Contents/Resources"
        
        # ç§»åŠ¨å¯æ‰§è¡Œæ–‡ä»¶
        mv "dist/${{ env.APP_NAME }}" "$APP_DIR/Contents/MacOS/"
        
        # è®¾ç½®å¯æ‰§è¡Œæƒé™
        chmod +x "$APP_DIR/Contents/MacOS/${{ env.APP_NAME }}"
        
        # åˆ›å»º Info.plist
        cat > "$APP_DIR/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>${{ env.APP_NAME }}</string>
            <key>CFBundleIdentifier</key>
            <string>com.jc0v0.pdd-customer-agent</string>
            <key>CFBundleName</key>
            <string>${{ env.APP_NAME }}</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
            <key>LSRequiresNativeExecution</key>
            <true/>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>LSApplicationCategoryType</key>
            <string>public.app-category.business</string>
            <key>NSAppleEventsUsageDescription</key>
            <string>æ­¤åº”ç”¨éœ€è¦è®¿é—®ç³»ç»Ÿäº‹ä»¶ä»¥å®ç°è‡ªåŠ¨åŒ–åŠŸèƒ½</string>
            <key>NSCameraUsageDescription</key>
            <string>æ­¤åº”ç”¨å¯èƒ½éœ€è¦è®¿é—®æ‘„åƒå¤´ä»¥å®ç°æŸäº›åŠŸèƒ½</string>
        </dict>
        </plist>
        EOF
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆè§£å†³æƒé™é—®é¢˜ï¼‰
        cat > "$APP_DIR/Contents/MacOS/launcher.sh" << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        export DYLD_LIBRARY_PATH="$DIR:$DYLD_LIBRARY_PATH"
        exec "$DIR/${{ env.APP_NAME }}" "$@"
        EOF
        
        chmod +x "$APP_DIR/Contents/MacOS/launcher.sh"
        
        # ç§»é™¤éš”ç¦»å±æ€§ï¼ˆé¿å… macOS å®‰å…¨è­¦å‘Šï¼‰
        xattr -cr "$APP_DIR" || true
        
        # åˆ›å»º DMG æ–‡ä»¶
        hdiutil create -volname "${{ env.APP_NAME }}" -srcfolder "$APP_DIR" -ov -format UDZO "dist/${{ env.APP_NAME }}-macOS-arm64.dmg"
        
        # ç§»é™¤ DMG çš„éš”ç¦»å±æ€§
        xattr -cr "dist/${{ env.APP_NAME }}-macOS-arm64.dmg" || true
    
    - name: Test macOS Application
      run: |
        if [ -f "dist/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}" ]; then
          echo "âœ… macOS åº”ç”¨æ„å»ºæˆåŠŸ"
          file_size=$(du -m "dist/${{ env.APP_NAME }}-macOS-arm64.dmg" | cut -f1)
          echo "ğŸ“¦ DMG æ–‡ä»¶å¤§å°: ${file_size} MB"
          
          # éªŒè¯åº”ç”¨ç»“æ„
          echo "ğŸ“ åº”ç”¨ç»“æ„:"
          find "dist/${{ env.APP_NAME }}.app" -type f | head -10
        else
          echo "âŒ macOS åº”ç”¨æ„å»ºå¤±è´¥"
          ls -la dist/
          exit 1
        fi
    
    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm64-dmg
        path: dist/${{ env.APP_NAME }}-macOS-arm64.dmg
        retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-x64-executable
        path: ./artifacts/windows/
    
    - name: Download macOS Artifact
      uses: actions/download-artifact@v4
      with:
        name: macos-arm64-dmg
        path: ./artifacts/macos/
    
    - name: Prepare Release Assets
      run: |
        mkdir -p release-assets
        
        # é‡å‘½åæ–‡ä»¶ä»¥åŒ…å«å¹³å°ä¿¡æ¯
        cp "./artifacts/windows/${{ env.APP_NAME }}.exe" "./release-assets/${{ env.APP_NAME }}-Windows-x64.exe"
        cp "./artifacts/macos/${{ env.APP_NAME }}-macOS-arm64.dmg" "./release-assets/"
        
        # åˆ›å»ºæ ¡éªŒå’Œæ–‡ä»¶
        cd release-assets
        sha256sum * > SHA256SUMS.txt
        cd ..
    
    - name: Generate Release Notes
      run: |
        cat > release-notes.md << EOF
        # ${{ env.APP_NAME }} Release
        
        ## ğŸ“¦ ä¸‹è½½
        
        ### Windows (x64)
        - **${{ env.APP_NAME }}-Windows-x64.exe** - Windows 10/11 å¯æ‰§è¡Œæ–‡ä»¶
        
        ### macOS (Apple Silicon)
        - **${{ env.APP_NAME }}-macOS-arm64.dmg** - macOS 11+ (M1/M2/M3 èŠ¯ç‰‡)
        
        ## ğŸš€ å®‰è£…è¯´æ˜
        
        ### Windows
        1. ä¸‹è½½ \`${{ env.APP_NAME }}-Windows-x64.exe\`
        2. åŒå‡»è¿è¡Œå³å¯
        3. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨å®‰è£…æµè§ˆå™¨é©±åŠ¨ï¼ˆéœ€è¦ç½‘ç»œè¿æ¥ï¼‰
        4. å¦‚é‡åˆ° Windows Defender è­¦å‘Šï¼Œè¯·æ·»åŠ åˆ°ä¿¡ä»»åˆ—è¡¨
        
        ### macOS
        1. ä¸‹è½½ \`${{ env.APP_NAME }}-macOS-arm64.dmg\`
        2. åŒå‡»æŒ‚è½½ DMG æ–‡ä»¶
        3. å°†åº”ç”¨æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
        4. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå³é”®ç‚¹å‡»åº”ç”¨é€‰æ‹©"æ‰“å¼€"ï¼ˆç»•è¿‡å®‰å…¨é™åˆ¶ï¼‰
        5. æˆ–åœ¨ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ä¸­å…è®¸è¿è¡Œ
        
        ## âš ï¸ é‡è¦æç¤º
        
        - **é¦–æ¬¡è¿è¡Œ**: éœ€è¦ç½‘ç»œè¿æ¥ä¸‹è½½æµè§ˆå™¨é©±åŠ¨ï¼Œè¯·è€å¿ƒç­‰å¾…
        - **Windows å®‰å…¨è­¦å‘Š**: è¿™æ˜¯ PyInstaller æ‰“åŒ…åº”ç”¨çš„å¸¸è§é—®é¢˜ï¼Œåº”ç”¨æ˜¯å®‰å…¨çš„
        - **macOS æƒé™**: é¦–æ¬¡è¿è¡Œéœ€è¦æˆäºˆå¿…è¦çš„ç³»ç»Ÿæƒé™
        
        ## ğŸ”§ ç³»ç»Ÿè¦æ±‚
        
        - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
        - **macOS**: macOS 11 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆä»…æ”¯æŒ Apple Silicon èŠ¯ç‰‡ï¼‰
        - **ç½‘ç»œ**: é¦–æ¬¡è¿è¡Œéœ€è¦ç½‘ç»œè¿æ¥
        
        ## ğŸ”’ æ–‡ä»¶æ ¡éªŒ
        
        è¯·ä½¿ç”¨ SHA256SUMS.txt éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚
        
        ## ğŸ› é—®é¢˜åé¦ˆ
        
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ GitHub Issues ä¸­åé¦ˆï¼Œå¹¶æä¾›ï¼š
        - æ“ä½œç³»ç»Ÿç‰ˆæœ¬
        - é”™è¯¯ä¿¡æ¯æˆªå›¾
        - æ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚æœ‰ï¼‰
        EOF
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name || format('v{0}', github.run_number) }}
        name: ${{ env.APP_NAME }} ${{ github.ref_name || format('v{0}', github.run_number) }}
        body_path: release-notes.md
        files: |
          release-assets/*
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-completion:
    name: Notify Build Completion
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build Status Summary
      run: |
        echo "## ğŸ—ï¸ æ„å»ºçŠ¶æ€æ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows x64 | ${{ needs.build-windows.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS ARM64 | ${{ needs.build-macos.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.build-windows.result }}" == "success" && "${{ needs.build-macos.result }}" == "success" ]]; then
          echo "ğŸ‰ æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- Windows: åœ¨ Artifacts ä¸­ä¸‹è½½ \`windows-x64-executable\`" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: åœ¨ Artifacts ä¸­ä¸‹è½½ \`macos-arm64-dmg\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ éƒ¨åˆ†å¹³å°æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
        fi